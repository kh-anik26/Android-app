name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      env:
        JAVA_HOME: ${{ env.JAVA_HOME_17_X64 }}

    # Debugging step: Print ANDROID_HOME to confirm it's set
    - name: Debug Android Home
      run: echo "ANDROID_HOME is: $ANDROID_HOME"

    - name: Install additional Android components
      run: |
        export JAVA_HOME=${{ env.JAVA_HOME_17_X64 }}
        # Install required SDK components, including latest cmdline-tools
        # Explicitly installing cmdline-tools;latest ensures sdkmanager is up-to-date
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "cmdline-tools;latest" "build-tools;33.0.2" "platforms;android-33" "ndk;23.2.8568313" "platform-tools"
        
        # Verify AIDL installation immediately after sdkmanager
        echo "Verifying AIDL after sdkmanager installation..."
        ls -la $ANDROID_HOME/build-tools/33.0.2/aidl || echo "AIDL not found at $ANDROID_HOME/build-tools/33.0.2/aidl"
        which aidl || echo "AIDL not found in current PATH after sdkmanager"
        echo "Current PATH: $PATH"
      env:
        SKIP_JDK_VERSION_CHECK: true

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git zip unzip python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev cmake libffi-dev libssl-dev build-essential libltdl-dev
        pip3 install --upgrade pip setuptools wheel
        pip3 install buildozer cython==0.29.33

    - name: Cache Buildozer global directory
      uses: actions/cache@v4
      with:
        path: ~/.buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('**/buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-

    - name: Cache Buildozer cache directory
      uses: actions/cache@v4
      with:
        path: .buildozer
        key: ${{ runner.os }}-buildozer-cache-${{ hashFiles('**/buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-

    - name: Build with Buildozer
      run: |
        # Explicitly set environment variables for this step
        export JAVA_HOME=${{ env.JAVA_HOME_17_X64 }}
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export ANDROID_NDK_HOME=$ANDROID_HOME/ndk/23.2.8568313
        
        # IMPORTANT: Prepend Android build tools to PATH for this step
        # This ensures buildozer can find AIDL and other tools, giving them priority.
        export PATH=$ANDROID_HOME/build-tools/33.0.2:$ANDROID_HOME/platform-tools:$PATH
        
        # Debugging: Print PATH just before buildozer runs
        echo "PATH before buildozer: $PATH"
        
        # Verify AIDL is accessible right before buildozer command
        # Try executing AIDL directly from its expected path to confirm executability
        echo "Attempting to execute AIDL directly for verification:"
        "$ANDROID_HOME/build-tools/33.0.2/aidl" --version || echo "Direct AIDL execution failed or version not found!"
        which aidl || echo "AIDL still not found in PATH before buildozer!"
        ls -la "$ANDROID_HOME/build-tools/33.0.2/aidl" || echo "AIDL file not found at expected location before buildozer!"
        
        # Accept any remaining licenses
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
        
        # Run buildozer
        buildozer android debug -v
      env:
        SKIP_JDK_VERSION_CHECK: true

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: bin/*.apk

    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        files: bin/*.apk
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
